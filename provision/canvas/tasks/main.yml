- name: delete vendor/bundle
  file: path=/vagrant/vendor/bundle state=absent

- name: delete Gemfile.lock
  file: path=/vagrant/Gemfile.lock state=absent

- name: bundle install
  sudo: no
  remote_user: vagrant
  shell: >
    bundle install --path=vendor/bundle --without=sqlite mysql
  args:
    chdir: /vagrant

- name: disable npm spinner
  shell: >
      npm config set spin=false
  remote_user: vagrant
  sudo: no

- name: npm install
  shell: npm install
  args:
    chdir: /vagrant
  remote_user: vagrant
  sudo: no

- name: compile assets
  shell: RAILS_ENV=production bundle exec rake canvas:compile_assets[false]
  args:
    chdir: /vagrant
  remote_user: vagrant
  sudo: no

- name: init databases
  shell: >
    RAILS_ENV=production \
    CANVAS_LMS_ADMIN_EMAIL=vagrant@localhost \
    CANVAS_LMS_ADMIN_PASSWORD=canvas4me \
    CANVAS_LMS_ACCOUNT_NAME="Simon Fraser University" \
    CANVAS_LMS_STATS_COLLECTION=opt_out \
    bundle exec rake db:initial_setup
  args:
    chdir: /vagrant

- name: symlink canvas_init script
  sudo: yes
  file:
    src=/vagrant/script/canvas_init
    dest=/etc/init.d/canvas_init
    state=link
  notify:
    - canvas_init restart

- name: update-rc.d canvas_init
  sudo: yes
  shell: update-rc.d canvas_init defaults